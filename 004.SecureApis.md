Securing **Web APIs** in **ASP.NET Core (.NET 8)** involves controlling **who can access your API**, **what they can do**, and **protecting sensitive data in transit**. Let‚Äôs go step by step.

# **1Ô∏è‚É£ Use HTTPS**

* Always serve your APIs over **HTTPS** to encrypt data in transit.
* In `Program.cs`:

```csharp
var builder = WebApplication.CreateBuilder(args);
builder.WebHost.UseUrls("https://localhost:5001");
```

* In production, configure SSL certificates in your server (IIS, Kestrel, or reverse proxy).

---

# **2Ô∏è‚É£ Authentication**

Authentication is **verifying who the user/client is**. Common approaches for APIs:

### **a) JWT Bearer Token (most common for APIs)**

* Client sends a JWT token in `Authorization` header:

  ```
  Authorization: Bearer <token>
  ```
* Configure in `Program.cs`:

```csharp
builder.Services.AddAuthentication("Bearer")
    .AddJwtBearer("Bearer", options =>
    {
        options.Authority = "https://your-identity-server";
        options.Audience = "your-api";
        options.TokenValidationParameters = new TokenValidationParameters
        {
            ValidateIssuer = true,
            ValidateAudience = true,
            ValidateLifetime = true
        };
    });

var app = builder.Build();
app.UseAuthentication();
app.UseAuthorization();
```

* Apply `[Authorize]` to controllers or endpoints:

```csharp
[Authorize]
[ApiController]
[Route("api/products")]
public class ProductsController : ControllerBase
{
    [HttpGet]
    public IActionResult GetProducts() => Ok(ProductService.GetAll());
}
```

---

### **b) API Keys**

* Simple method for server-to-server APIs.
* Client sends `x-api-key` header, validate in middleware:

```csharp
app.Use(async (context, next) =>
{
    if (!context.Request.Headers.TryGetValue("x-api-key", out var key) || key != "my-secret-key")
    {
        context.Response.StatusCode = 401;
        await context.Response.WriteAsync("Unauthorized");
        return;
    }
    await next();
});
```

---

### **c) OAuth2 / OpenID Connect**

* Used for **enterprise authentication**
* Can integrate with Azure AD, IdentityServer, Auth0, etc.
* Similar to JWT but often includes **refresh tokens** and scopes.

---

# **3Ô∏è‚É£ Authorization**

* Determines **what an authenticated user can do**.
* In controllers or minimal APIs:

```csharp
[Authorize(Roles = "Admin")]
[HttpPost]
public IActionResult CreateProduct([FromBody] ProductDto product) { ... }
```

* For **Minimal APIs**:

```csharp
app.MapPost("/products", (ProductDto p, ProductService s) => s.Add(p))
   .RequireAuthorization("Admin");
```

---

# **4Ô∏è‚É£ CORS (Cross-Origin Resource Sharing)**

* Needed if your API is called from **browsers on other domains**.
* Example:

```csharp
builder.Services.AddCors(options =>
{
    options.AddPolicy("AllowSpecificOrigin",
        builder => builder.WithOrigins("https://example.com")
                          .AllowAnyHeader()
                          .AllowAnyMethod());
});

app.UseCors("AllowSpecificOrigin");
```

---

# **5Ô∏è‚É£ Rate Limiting / Throttling**

* Prevent abuse or DDoS.
* ASP.NET Core 8 has **built-in rate limiting**:

```csharp
builder.Services.AddRateLimiter(options =>
{
    options.AddPolicy("fixed", context => RateLimitPartition.GetFixedWindowLimiter(
        partitionKey: context.Request.Headers.Host!,
        factory: _ => new FixedWindowRateLimiterOptions
        {
            PermitLimit = 10,
            Window = TimeSpan.FromSeconds(10)
        }));
});

app.UseRateLimiter();
```

---

# **6Ô∏è‚É£ Input Validation / Model Validation**

* Always validate **request body** to prevent malicious input.
* `[ApiController]` + data annotations:

```csharp
public class ProductDto
{
    [Required]
    public string Name { get; set; }

    [Range(1, 10000)]
    public decimal Price { get; set; }
}
```

* Automatically returns `400 Bad Request` if validation fails.

---

# **7Ô∏è‚É£ Logging and Monitoring**

* Log authentication failures, authorization errors, and unusual activity.
* Integrate with **Serilog**, **Application Insights**, or **ELK stack**.

---

# **8Ô∏è‚É£ Secure Sensitive Data**

* Never store secrets (connection strings, keys) in code. Use:

  * **Azure Key Vault**
  * **Environment variables**
  * **appsettings.json with Secret Manager for development**

* Use **HTTPS** and **JWT** instead of sending credentials in plain text.

---

# **Summary Table**

| Layer            | How to Secure          | ASP.NET Core Example                |
| ---------------- | ---------------------- | ----------------------------------- |
| Transport        | HTTPS                  | Kestrel SSL / UseHttpsRedirection() |
| Authentication   | JWT / API Key / OAuth2 | AddAuthentication().AddJwtBearer()  |
| Authorization    | Roles / Policies       | `[Authorize(Roles="Admin")]`        |
| Cross-Origin     | CORS                   | AddCors() + UseCors()               |
| Throttling       | Rate limiting          | AddRateLimiter() + UseRateLimiter() |
| Input validation | DataAnnotations        | `[Required]`, `[Range]`             |
| Secrets          | Secure storage         | Key Vault / Env variables           |

---

üí° **Tip:**
For **modern Web APIs**, the common stack is:

1. **HTTPS**
2. **JWT Authentication**
3. **Role-based or policy-based authorization**
4. **CORS** (if browser clients)
5. **Rate limiting** (optional but recommended)

